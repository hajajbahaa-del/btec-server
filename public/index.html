<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BTEC - منصة مهندس بهاء</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
    :root{
      --card:#ffffff; --text:#101828; --muted:#667085;
      --primary:#0d39ff; --primary2:#000000;
      --line:#e6e9f5; --soft:#f5f7ff;
      --shadow: 0 18px 45px rgba(0,0,0,.22);
      --shadow2: 0 10px 25px rgba(0,0,0,.18);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Tajawal",system-ui,Arial;
      background: linear-gradient(135deg, #000 0%, #1a1a2e 100%);
      color:#fff; min-height:100vh;
    }
    .topbar{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary2) 100%);
      box-shadow: var(--shadow2);
    }
    .topbar .inner{
      max-width:1100px; margin:0 auto; padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; flex-direction:column; gap:2px; text-decoration:none; color:#fff;}
    .brand b{font-size:16px}
    .brand span{font-size:12px; opacity:.9}

    .nav{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    .btn{
      border:0; cursor:pointer; font-family:inherit;
      padding:10px 12px; border-radius:12px;
      background:#fff; color:var(--primary);
      font-weight:800;
      transition:.15s transform ease, .15s opacity ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .btn:hover{transform: translateY(-1px); opacity:.95}
    .btn.ghost{background: rgba(255,255,255,.14); color:#fff; border:1px solid rgba(255,255,255,.22);}
    .btn.danger{background: #ffe4e2; color:#b42318}
    .btn.ok{background: #d1fadf; color:#027a48}
    .btn.dark{background:#101828; color:#fff}
    .btn.small{padding:8px 10px; border-radius:10px; font-weight:800; font-size:13px}

    .wrap{max-width:1100px; margin:18px auto; padding:0 14px}
    .grid{display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:14px}
    .card{
      background: var(--card); color: var(--text);
      border-radius: var(--r); box-shadow: var(--shadow);
      padding:16px; overflow:hidden;
    }
    .card.soft{background:#fbfcff}
    .cardHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      padding-bottom:12px; margin-bottom:12px;
    }
    .h1{margin:0; font-size:26px; font-weight:900; color:var(--primary)}
    .h2{margin:0; font-size:18px; font-weight:900}
    .muted{color:var(--muted); font-size:14px}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:800;
      background: var(--soft); color: var(--primary);
      border:1px solid var(--line);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      padding:12px; border-radius:14px;
      background: var(--soft);
      border:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .item:hover{border-color:#b9c4ff}
    .item .title{font-weight:900}
    .item .sub{font-size:13px; color:var(--muted); margin-top:2px}
    .item .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .form{display:flex; flex-direction:column; gap:10px}
    label{font-size:13px; font-weight:900; color:#344054}
    input, textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #d0d5dd;
      font-family:inherit;
      outline:none;
      background:#fff;
    }
    textarea{min-height:120px; resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:#98a6ff; box-shadow:0 0 0 4px rgba(13,57,255,.12)}
    .help{font-size:12px; color:var(--muted)}
    .split{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 720px){ .split{grid-template-columns:1fr} }

    .alert{
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--line);
      background:#fff; color:#111;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .alert.ok{border-color:#abefc6; background:#ecfdf3}
    .alert.bad{border-color:#fecdca; background:#fffbfa}
    .alert.warn{border-color:#fedf89; background:#fffaeb}
    .hide{display:none !important}

    .lessonWrap{background:#fff; color:#111; border-radius:18px; overflow:hidden; box-shadow:var(--shadow);}
    .lessonHeader{background:linear-gradient(135deg, var(--primary) 0%, #000 100%); color:#fff; padding:20px;}
    .lessonTitle{margin:8px 0 0; font-size:26px; font-weight:1000}
    .lessonBody{padding:18px; line-height:1.95}
    .slide{
      border:1px solid var(--line); background:#fbfcff; border-radius:16px;
      padding:14px; margin-bottom:12px;
    }
    .slide h3{margin:0 0 8px;color:var(--primary)}
    .slide ul{margin:0; padding-right:18px}
    .slide pre{
      background:#111827; color:#d1fae5;
      padding:12px; border-radius:14px;
      overflow:auto; direction:ltr; text-align:left;
      margin:10px 0 0;
    }
    .footer{margin:20px 0 30px; text-align:center; opacity:.9; font-size:13px;}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <a class="brand" href="#/">
        <b>(BTEC) منصة مهندس بهاء حجيج</b>
        <span>أجيال + مهمات + مستندات • ودروس Python برسنتيشن</span>
      </a>

      <div class="nav">
        <button class="btn ghost" onclick="go('#/')">الرئيسية</button>
        <button class="btn ghost" onclick="go('#/python')">دروس بايثون</button>
        <button class="btn ghost" onclick="go('#/search')">بحث</button>

        <button class="btn ghost" onclick="go('#/login')" id="loginBtn">دخول أدمن</button>
        <button class="btn ghost hide" onclick="go('#/admin')" id="adminBtn">لوحة التحكم</button>
        <button class="btn danger small hide" onclick="logout()" id="logoutBtn">خروج</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="alertBox" class="alert hide"></div>

    <div id="page-home" class="grid hide"></div>
    <div id="page-task" class="hide"></div>

    <div id="page-python" class="hide"></div>
    <div id="page-python-lesson" class="hide"></div>

    <div id="page-search" class="hide"></div>
    <div id="page-login" class="hide"></div>
    <div id="page-admin" class="hide"></div>

    <div class="footer">
      © منصة BTEC – إعداد مهندس بهاء | Instagram: <b>btec_zone.2_008</b>
    </div>
  </div>

<script>
/* =========================
   API + Utilities
========================= */
const $ = (sel) => document.querySelector(sel);
const esc = (s="") => String(s)
  .replaceAll("&","&amp;").replaceAll("<","&lt;")
  .replaceAll(">","&gt;")
  .replaceAll('"',"&quot;")
  .replaceAll("'","&#039;");

function showAlert(type, msg){
  const box = $("#alertBox");
  box.className = "alert " + (type || "");
  box.innerHTML = `<div><b>${type==="ok"?"✅":"⚠️"}</b> ${esc(msg)}</div>
                   <button class="btn small dark" onclick="hideAlert()">إغلاق</button>`;
  box.classList.remove("hide");
}
function hideAlert(){ $("#alertBox").classList.add("hide"); }
function go(hash){ location.hash = hash; }

const AUTH_KEY = "btec_admin_token_v1";
function getToken(){ return localStorage.getItem(AUTH_KEY) || ""; }
function setToken(t){ t ? localStorage.setItem(AUTH_KEY,t) : localStorage.removeItem(AUTH_KEY); renderNav(); }

async function api(path, opts = {}){
  const headers = Object.assign({ "Content-Type":"application/json" }, opts.headers || {});
  const tok = getToken();
  if (tok) headers["Authorization"] = "Bearer " + tok;
  const res = await fetch(path, Object.assign({}, opts, { headers }));
  const data = await res.json().catch(()=>({ok:false,msg:"bad json"}));
  if (!res.ok) throw new Error(data?.msg || "Request failed");
  return data;
}

/* =========================
   State
========================= */
let DB = { generations:[], tasks:[], taskDocs:[], pythonLessons:[] };

async function refreshState(){
  const r = await api("/api/public/state", { method:"GET", headers:{} });
  DB = r.data;
}

/* =========================
   Nav
========================= */
function renderNav(){
  const authed = !!getToken();
  $("#loginBtn").classList.toggle("hide", authed);
  $("#logoutBtn").classList.toggle("hide", !authed);
  $("#adminBtn").classList.toggle("hide", !authed);
}

/* =========================
   Router
========================= */
function hideAllPages(){
  ["home","task","python","python-lesson","search","login","admin"].forEach(p=>{
    $("#page-"+p).classList.add("hide");
  });
}

async function route(){
  hideAlert();
  hideAllPages();

  try{
    await refreshState();
  }catch(e){
    // لو السيرفر نايم/مشكلة شبكة
    showAlert("bad","في مشكلة اتصال بالسيرفر. جرّب تحديث الصفحة.");
  }

  const hash = location.hash || "#/";
  const parts = hash.replace("#","").split("/").filter(Boolean);
  if(parts.length === 0) return renderHome();

  const [p, id] = parts;
  if(p === "task" && id) return renderTask(id);
  if(p === "python") return renderPython();
  if(p === "pythonLesson" && id) return renderPythonLesson(id);
  if(p === "search") return renderSearch();
  if(p === "login") return renderLogin();
  if(p === "admin") return renderAdmin();

  renderHome();
}

/* =========================
   Pages - Home
========================= */
function tasksByGen(genId){ return DB.tasks.filter(t => t.genId === genId); }
function docsByTask(taskId){ return DB.taskDocs.filter(d => d.taskId === taskId).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)); }
function pythonLessonsSorted(){ return DB.pythonLessons.slice().sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)); }

function renderHome(){
  const root = $("#page-home");
  root.classList.remove("hide");

  const py = pythonLessonsSorted().slice(0,5);

  root.innerHTML = `
    <div class="card" style="grid-column: 1/-1;">
      <div class="cardHeader">
        <div>
          <h1 class="h1">الرئيسية</h1>
          <div class="muted">كل البيانات محفوظة على السيرفر (تشتغل على أي جهاز).</div>
        </div>
        <div class="row">
          <button class="btn ghost dark" onclick="go('#/python')">دروس بايثون</button>
        </div>
      </div>

      <div class="alert ok">
        <div><b>✅ ممتاز:</b> ما في Backup ولا Import. أي طالب يشوف الدروس فورًا من أي جهاز.</div>
        <button class="btn small dark" onclick="hideAlert()">تمام</button>
      </div>
    </div>

    <div class="card soft" style="grid-column: 1/-1;">
      <div class="cardHeader">
        <div>
          <div class="h2">تعلم دروس بايثون من تحت صفر (Python)</div>
          <div class="muted">تضاف من لوحة التحكم (برسنتيشن).</div>
        </div>
      </div>
      <div class="list">
        ${
          py.length ? py.map(l=>`
            <div class="item">
              <div>
                <div class="title">${esc(l.title)}</div>
                <div class="sub">${new Date(l.createdAt||Date.now()).toLocaleDateString("ar")}</div>
              </div>
              <div class="meta">
                <button class="btn small" onclick="go('#/pythonLesson/${l.id}')">فتح</button>
              </div>
            </div>
          `).join("") : `<div class="muted">لا يوجد دروس بايثون بعد.</div>`
        }
      </div>
    </div>
  `;

  DB.generations.forEach(g=>{
    const tasks = tasksByGen(g.id);
    const html = `
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="h2">${esc(g.name)}</div>
            <div class="muted">${esc(g.descr || "")}</div>
          </div>
          <span class="pill">${tasks.length} مهمة</span>
        </div>

        <div class="list">
          ${
            tasks.length ? tasks.map(t=>{
              const docsCount = docsByTask(t.id).length;
              return `
                <div class="item">
                  <div>
                    <div class="title">${esc(t.title)}</div>
                    <div class="sub">${esc(t.descr||"")} • ${docsCount} مستند</div>
                  </div>
                  <div class="meta">
                    <button class="btn small" onclick="go('#/task/${t.id}')">فتح المهمة</button>
                  </div>
                </div>
              `;
            }).join("") : `<div class="muted">لا يوجد مهام بعد.</div>`
          }
        </div>
      </div>
    `;
    root.insertAdjacentHTML("beforeend", html);
  });
}

/* =========================
   Task page
========================= */
function findBy(arr, id){ return arr.find(x => x.id === id); }

function renderTask(taskId){
  const task = findBy(DB.tasks, taskId);
  if(!task){ showAlert("bad","المهمة غير موجودة"); return go("#/"); }

  const gen = findBy(DB.generations, task.genId);
  const docs = docsByTask(taskId);

  const root = $("#page-task");
  root.classList.remove("hide");

  root.innerHTML = `
    <div class="card">
      <div class="cardHeader">
        <div>
          <h1 class="h1">${esc(task.title)}</h1>
          <div class="muted">الجيل: <b>${esc(gen?.name||"-")}</b></div>
          <div class="muted">${esc(task.descr||"")}</div>
        </div>
        <div class="row">
          <button class="btn ghost dark" onclick="go('#/')">رجوع</button>
          <span class="pill">${docs.length} مستند</span>
        </div>
      </div>

      <div class="grid">
        <div class="card soft">
          <div class="cardHeader">
            <div>
              <div class="h2">مستندات المهمة</div>
              <div class="muted">تنزيل مستندات هذه المهمة.</div>
            </div>
          </div>

          <div class="list">
            ${
              docs.length ? docs.map(d=>`
                <div class="item">
                  <div>
                    <div class="title">${esc(d.displayName)}</div>
                    <div class="sub">${esc(d.filename)} • ${Math.round((d.size||0)/1024)} KB</div>
                  </div>
                  <div class="meta">
                    <a class="btn small ok" href="${esc(d.url)}" target="_blank" rel="noopener">تنزيل</a>
                  </div>
                </div>
              `).join("") : `<div class="muted">لا يوجد مستندات بعد.</div>`
            }
          </div>
        </div>

        <div class="card soft">
          <div class="cardHeader">
            <div>
              <div class="h2">ملاحظات المهمة</div>
              <div class="muted">الوصف يظهر هنا.</div>
            </div>
          </div>
          <div class="muted">${esc(task.descr || "لا يوجد وصف بعد.")}</div>
        </div>
      </div>
    </div>
  `;
}

/* =========================
   Python pages
========================= */
function renderPython(){
  const root = $("#page-python");
  root.classList.remove("hide");

  const lessons = pythonLessonsSorted();

  root.innerHTML = `
    <div class="card">
      <div class="cardHeader">
        <div>
          <h1 class="h1">دروس بايثون</h1>
          <div class="muted">دروس على شكل برسنتيشن (شرائح).</div>
        </div>
        <button class="btn ghost dark" onclick="go('#/')">رجوع</button>
      </div>

      <div class="list">
        ${
          lessons.length ? lessons.map(l=>`
            <div class="item">
              <div>
                <div class="title">${esc(l.title)}</div>
                <div class="sub">${new Date(l.createdAt||Date.now()).toLocaleString("ar")}</div>
              </div>
              <div class="meta">
                <button class="btn small" onclick="go('#/pythonLesson/${l.id}')">فتح</button>
              </div>
            </div>
          `).join("") : `<div class="muted">لا يوجد دروس بعد.</div>`
        }
      </div>
    </div>
  `;
}

function renderPythonLesson(id){
  const lesson = findBy(DB.pythonLessons, id);
  if(!lesson){ showAlert("bad","درس بايثون غير موجود"); return go("#/python"); }

  const root = $("#page-python-lesson");
  root.classList.remove("hide");

  root.innerHTML = `
    <div class="lessonWrap">
      <div class="lessonHeader">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:900;opacity:.95">بسم الله الرحمن الرحيم</div>
            <div class="lessonTitle">${esc(lesson.title)}</div>
          </div>
          <div class="row">
            <button class="btn ghost" onclick="go('#/python')">رجوع</button>
            <button class="btn ghost" onclick="go('#/')">الرئيسية</button>
          </div>
        </div>
      </div>

      <div class="lessonBody">
        ${
          (lesson.slides||[]).length ? (lesson.slides||[]).map((s,idx)=>`
            <div class="slide">
              <h3>${idx+1}. ${esc(s.title || "شريحة")}</h3>
              ${
                (s.bullets||[]).length ? `<ul>${s.bullets.map(b=>`<li>${esc(b)}</li>`).join("")}</ul>` : `<div class="muted">—</div>`
              }
              ${ s.code ? `<pre>${esc(s.code)}</pre>` : `` }
            </div>
          `).join("") : `<div class="muted">لا يوجد شرائح بعد.</div>`
        }
      </div>
    </div>
  `;
}

/* =========================
   Search
========================= */
function renderSearch(){
  const root = $("#page-search");
  root.classList.remove("hide");

  root.innerHTML = `
    <div class="card">
      <div class="cardHeader">
        <div>
          <h1 class="h1">بحث</h1>
          <div class="muted">ابحث داخل الأجيال/المهمات/المستندات/دروس بايثون.</div>
        </div>
        <button class="btn ghost dark" onclick="go('#/')">رجوع</button>
      </div>

      <div class="form">
        <label>اكتب كلمة البحث</label>
        <input id="q" placeholder="مثال: مهمة قواعد / متغيرات / loops ..." oninput="doSearch()">
      </div>

      <div id="searchResults" class="grid" style="margin-top:14px"></div>
    </div>
  `;

  doSearch();
}

function doSearch(){
  const q = ($("#q")?.value || "").trim().toLowerCase();
  const out = $("#searchResults");
  if(!out) return;

  const match = (s)=> (s||"").toLowerCase().includes(q);
  if(!q){
    out.innerHTML = `<div class="card soft" style="grid-column:1/-1"><div class="muted">اكتب كلمة للبحث…</div></div>`;
    return;
  }

  const gens = DB.generations.filter(g=> match(g.name) || match(g.descr));
  const tasks = DB.tasks.filter(t=> match(t.title) || match(t.descr));
  const docs = DB.taskDocs.filter(d=> match(d.displayName) || match(d.filename));
  const py = DB.pythonLessons.filter(l=> match(l.title) || (l.slides||[]).some(s=> match(s.title) || (s.bullets||[]).some(b=>match(b)) || match(s.code)));

  const mk = (title, items) => `
    <div class="card soft">
      <div class="cardHeader">
        <div class="h2">${title}</div>
        <span class="pill">${items.length}</span>
      </div>
      <div class="list">${items.length ? items.join("") : `<div class="muted">لا نتائج</div>`}</div>
    </div>
  `;

  out.innerHTML = `
    ${mk("الأجيال", gens.map(g=>`
      <div class="item">
        <div>
          <div class="title">${esc(g.name)}</div>
          <div class="sub">${esc(g.descr||"")}</div>
        </div>
        <div class="meta"><span class="pill">جيل</span></div>
      </div>
    `))}
    ${mk("المهمات", tasks.map(t=>`
      <div class="item">
        <div>
          <div class="title">${esc(t.title)}</div>
          <div class="sub">${esc(t.descr||"")}</div>
        </div>
        <div class="meta">
          <button class="btn small" onclick="go('#/task/${t.id}')">فتح</button>
        </div>
      </div>
    `))}
    ${mk("المستندات", docs.map(d=>`
      <div class="item">
        <div>
          <div class="title">${esc(d.displayName)}</div>
          <div class="sub">${esc(d.filename)}</div>
        </div>
        <div class="meta">
          <a class="btn small ok" href="${esc(d.url)}" target="_blank" rel="noopener">تنزيل</a>
        </div>
      </div>
    `))}
    ${mk("دروس بايثون", py.map(l=>`
      <div class="item">
        <div>
          <div class="title">${esc(l.title)}</div>
          <div class="sub">درس برسنتيشن</div>
        </div>
        <div class="meta">
          <button class="btn small" onclick="go('#/pythonLesson/${l.id}')">فتح</button>
        </div>
      </div>
    `))}
  `;
}

/* =========================
   Login/Admin
========================= */
function logout(){
  // محاولة تسجيل خروج من السيرفر (مش ضروري)
  fetch("/api/admin/logout", { method:"POST", headers: { "Authorization":"Bearer "+getToken() } })
    .catch(()=>{})
    .finally(()=>{
      setToken("");
      showAlert("ok","تم تسجيل الخروج");
      go("#/");
    });
}

function renderLogin(){
  const root = $("#page-login");
  root.classList.remove("hide");

  root.innerHTML = `
    <div class="card" style="max-width:520px;margin:0 auto;">
      <div class="cardHeader">
        <div>
          <h1 class="h1">دخول الأدمن</h1>
          <div class="muted">أدخل بيانات الأدمن (الموجودة في السيرفر).</div>
        </div>
        <button class="btn ghost dark" onclick="go('#/')">رجوع</button>
      </div>

      <form class="form" onsubmit="event.preventDefault(); doAdminLogin();">
        <label>اسم المستخدم</label>
        <input id="a_user" autocomplete="username" placeholder="bahaa_hajaj" required>

        <label>كلمة المرور</label>
        <input id="a_pass" type="password" autocomplete="current-password" required>

        <button class="btn" type="submit">تسجيل الدخول</button>
      </form>
    </div>
  `;
}

async function doAdminLogin(){
  try{
    const username = ($("#a_user").value||"").trim();
    const password = ($("#a_pass").value||"").trim();
    const r = await api("/api/admin/login", { method:"POST", body: JSON.stringify({ username, password }) });
    setToken(r.token);
    showAlert("ok","تم تسجيل الدخول ✅");
    go("#/admin");
  }catch(e){
    showAlert("bad", e.message || "فشل تسجيل الدخول");
  }
}

function requireAdminUI(){
  if(!getToken()){
    showAlert("bad","هذه الصفحة للأدمن فقط. سجّل دخول أولاً.");
    go("#/login");
    return false;
  }
  return true;
}

let PY_DRAFT = [];

function renderAdmin(){
  if(!requireAdminUI()) return;

  const root = $("#page-admin");
  root.classList.remove("hide");

  root.innerHTML = `
    <div class="card">
      <div class="cardHeader">
        <div>
          <h1 class="h1">لوحة التحكم</h1>
          <div class="muted">كل التعديلات تنحفظ على السيرفر وتظهر للطلاب فورًا.</div>
        </div>
        <div class="row">
          <button class="btn ghost dark" onclick="go('#/')">عرض الموقع</button>
          <button class="btn danger" onclick="resetAllConfirm()">إعادة ضبط البيانات</button>
        </div>
      </div>

      <div class="grid">
        ${statsCard("الأجيال", DB.generations.length)}
        ${statsCard("المهمات", DB.tasks.length)}
        ${statsCard("مستندات المهمات", DB.taskDocs.length)}
        ${statsCard("دروس بايثون", DB.pythonLessons.length)}
      </div>
    </div>

    <div class="grid" style="margin-top:14px">

      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="h2">إضافة جيل</div>
            <div class="muted">اكتب اسم الجيل.</div>
          </div>
        </div>
        <form class="form" onsubmit="event.preventDefault(); addGen();">
          <label>اسم الجيل</label>
          <input id="genName" placeholder="مثال: جيل 2011" required>
          <label>وصف مختصر</label>
          <input id="genDesc" placeholder="اختياري">
          <button class="btn" type="submit">إضافة</button>
        </form>

        <div style="margin-top:12px" class="list">
          ${DB.generations.map(g=>`
            <div class="item">
              <div>
                <div class="title">${esc(g.name)}</div>
                <div class="sub">${esc(g.descr||"")}</div>
              </div>
              <div class="meta">
                <button class="btn small danger" onclick="delGen('${g.id}')">حذف</button>
              </div>
            </div>
          `).join("")}
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="h2">إضافة مهمة داخل جيل</div>
            <div class="muted">اختر الجيل ثم اكتب اسم المهمة.</div>
          </div>
        </div>
        <form class="form" onsubmit="event.preventDefault(); addTask();">
          <label>اختر الجيل</label>
          <select id="taskGenId" required>
            ${DB.generations.map(g=>`<option value="${g.id}">${esc(g.name)}</option>`).join("")}
          </select>

          <label>اسم المهمة</label>
          <input id="taskTitle" placeholder="مثال: مهمة قواعد البيانات" required>

          <label>وصف المهمة</label>
          <input id="taskDesc" placeholder="اختياري">

          <button class="btn" type="submit">إضافة</button>
        </form>

        <div style="margin-top:12px" class="list">
          ${DB.tasks.slice().sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)).map(t=>{
            const g = findBy(DB.generations, t.genId);
            return `
              <div class="item">
                <div>
                  <div class="title">${esc(t.title)}</div>
                  <div class="sub">${esc(g?.name||"-")} • ${esc(t.descr||"")}</div>
                </div>
                <div class="meta">
                  <button class="btn small" onclick="go('#/task/${t.id}')">فتح</button>
                  <button class="btn small danger" onclick="delTask('${t.id}')">حذف</button>
                </div>
              </div>
            `;
          }).join("") || `<div class="muted">لا يوجد مهمات بعد.</div>`}
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="h2">رفع مستند لمهمة</div>
            <div class="muted">اختر الجيل ثم المهمة ثم ارفع الملف.</div>
          </div>
        </div>

        <form class="form" onsubmit="event.preventDefault(); uploadDoc();">
          <label>اختر الجيل</label>
          <select id="docGenId" onchange="refreshDocTasks()" required>
            ${DB.generations.map(g=>`<option value="${g.id}">${esc(g.name)}</option>`).join("")}
          </select>

          <label>اختر المهمة</label>
          <select id="docTaskId" required></select>

          <label>اسم المستند (يظهر للطلاب)</label>
          <input id="docDisplayName" placeholder="مثال: حل المهمة PDF" required>

          <label>اختر الملف</label>
          <input id="docFile" type="file" required>

          <button class="btn" type="submit">رفع</button>
          <div class="help">الملف ينرفع على السيرفر ويصير رابط تنزيل للطلاب.</div>
        </form>

        <div style="margin-top:12px" class="list">
          ${DB.taskDocs.slice().sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)).slice(0,12).map(d=>{
            const t = findBy(DB.tasks, d.taskId);
            const g = t ? findBy(DB.generations, t.genId) : null;
            return `
              <div class="item">
                <div>
                  <div class="title">${esc(d.displayName)}</div>
                  <div class="sub">${esc(g?.name||"-")} • ${esc(t?.title||"-")} • ${esc(d.filename)}</div>
                </div>
                <div class="meta">
                  <a class="btn small ok" href="${esc(d.url)}" target="_blank" rel="noopener">فتح</a>
                  <button class="btn small danger" onclick="delDoc('${d.id}')">حذف</button>
                </div>
              </div>
            `;
          }).join("") || `<div class="muted">لا يوجد مستندات بعد.</div>`}
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="h2">إضافة درس بايثون (برسنتيشن)</div>
            <div class="muted">أضف شرائح ثم احفظ.</div>
          </div>
        </div>

        <form class="form" onsubmit="event.preventDefault(); return false;">
          <label>عنوان الدرس</label>
          <input id="pyTitle" placeholder="مثال: المتغيرات في بايثون" required>

          <div class="split">
            <div>
              <label>عنوان الشريحة</label>
              <input id="pySlideTitle" placeholder="مثال: ما هو المتغير؟">
            </div>
            <div>
              <label>كود (اختياري)</label>
              <input id="pySlideCodeOneLine" placeholder='مثال: name = "Ali"'>
            </div>
          </div>

          <label>نقاط الشريحة (كل سطر نقطة)</label>
          <textarea id="pySlideBullets" placeholder="اكتب نقاط...\nكل سطر = نقطة"></textarea>

          <div class="row">
            <button class="btn dark" type="button" onclick="addSlideToDraft()">+ إضافة الشريحة</button>
            <span class="pill" id="draftCount">0 شريحة</span>
            <button class="btn" type="button" onclick="savePythonLesson()">حفظ الدرس</button>
          </div>

          <div id="draftPreview" class="list" style="margin-top:10px"></div>
        </form>

        <div style="margin-top:12px" class="list">
          ${pythonLessonsSorted().slice(0,10).map(l=>`
            <div class="item">
              <div>
                <div class="title">${esc(l.title)}</div>
                <div class="sub">${(l.slides||[]).length} شريحة • ${new Date(l.createdAt||Date.now()).toLocaleDateString("ar")}</div>
              </div>
              <div class="meta">
                <button class="btn small" onclick="go('#/pythonLesson/${l.id}')">فتح</button>
                <button class="btn small danger" onclick="delPythonLesson('${l.id}')">حذف</button>
              </div>
            </div>
          `).join("") || `<div class="muted">لا يوجد دروس بايثون بعد.</div>`}
        </div>
      </div>

    </div>
  `;

  refreshDocTasks();
  renderDraft();
}

function statsCard(title, num){
  return `
    <div class="card soft">
      <div class="h2">${esc(title)}</div>
      <div style="font-size:34px;font-weight:1000;color:var(--primary);margin-top:6px">${num}</div>
    </div>
  `;
}

function refreshDocTasks(){
  const genId = $("#docGenId")?.value;
  const sel = $("#docTaskId");
  if(!sel) return;

  const tasks = DB.tasks.filter(t=>t.genId === genId);
  sel.innerHTML = tasks.length
    ? tasks.map(t=>`<option value="${t.id}">${esc(t.title)}</option>`).join("")
    : `<option value="">لا يوجد مهمات لهذا الجيل</option>`;
}

/* ===== Admin Actions ===== */
async function addGen(){
  try{
    const name = ($("#genName").value||"").trim();
    const descr = ($("#genDesc").value||"").trim();
    await api("/api/admin/generations", { method:"POST", body: JSON.stringify({ name, descr }) });
    showAlert("ok","تم إضافة الجيل ✅");
    await route();
  }catch(e){ showAlert("bad", e.message); }
}

async function delGen(id){
  if(!confirm("حذف الجيل سيحذف المهمات والمستندات التابعة له. متابعة؟")) return;
  try{
    await api("/api/admin/generations/"+id, { method:"DELETE" });
    showAlert("ok","تم حذف الجيل ✅");
    await route();
  }catch(e){ showAlert("bad", e.message); }
}

async function addTask(){
  try{
    const genId = $("#taskGenId").value;
    const title = ($("#taskTitle").value||"").trim();
    const descr = ($("#taskDesc").value||"").trim();
    await api("/api/admin/tasks", { method:"POST", body: JSON.stringify({ genId, title, descr }) });
    showAlert("ok","تم إضافة المهمة ✅");
    await route();
  }catch(e){ showAlert("bad", e.message); }
}

async function delTask(id){
  if(!confirm("حذف المهمة سيحذف المستندات التابعة لها. متابعة؟")) return;
  try{
    await api("/api/admin/tasks/"+id, { method:"DELETE" });
    showAlert("ok","تم حذف المهمة ✅");
    await route();
  }catch(e){ showAlert("bad", e.message); }
}

async function uploadDoc(){
  try{
    const taskId = $("#docTaskId").value;
    const displayName = ($("#docDisplayName").value||"").trim();
    const file = $("#docFile").files?.[0];
    if(!taskId) throw new Error("اختر مهمة صحيحة");
    if(!displayName) throw new Error("اكتب اسم المستند");
    if(!file) throw new Error("اختر ملفًا");

    const form = new FormData();
    form.append("taskId", taskId);
    form.append("displayName", displayName);
    form.append("file", file);

    const tok = getToken();
    const res = await fetch("/api/admin/taskdocs/upload", {
      method:"POST",
      headers: { "Authorization":"Bearer "+tok },
      body: form
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data?.msg || "فشل الرفع");

    showAlert("ok","تم رفع المستند ✅");
    await route();
  }catch(e){ showAlert("bad", e.message); }
}

async function delDoc(id){
  if(!confirm("حذف المستند؟")) return;
  try{
    await api("/api/admin/taskdocs/"+id, { method:"DELETE" });
    showAlert("ok","تم حذف المستند ✅");
    await route();
  }catch(e){ showAlert("bad", e.message); }
}

function addSlideToDraft(){
  const title = ($("#pySlideTitle").value||"").trim();
  const bulletsText = ($("#pySlideBullets").value||"").trim();
  const code = ($("#pySlideCodeOneLine").value||"").trim();
  if(!title){ showAlert("bad","اكتب عنوان الشريحة"); return; }

  const bullets = bulletsText
    ? bulletsText.split("\n").map(x=>x.trim()).filter(Boolean)
    : [];

  PY_DRAFT.push({ title, bullets, code });
  $("#pySlideTitle").value = "";
  $("#pySlideBullets").value = "";
  $("#pySlideCodeOneLine").value = "";
  renderDraft();
}

function renderDraft(){
  const cnt = $("#draftCount");
  const prev = $("#draftPreview");
  if(cnt) cnt.textContent = `${PY_DRAFT.length} شريحة`;
  if(!prev) return;

  prev.innerHTML = PY_DRAFT.map((s,idx)=>`
    <div class="item">
      <div>
        <div class="title">${idx+1}. ${esc(s.title)}</div>
        <div class="sub">${(s.bullets||[]).length} نقاط ${s.code ? "• مع كود" : ""}</div>
      </div>
      <div class="meta">
        <button class="btn small danger" type="button" onclick="removeDraftSlide(${idx})">حذف</button>
      </div>
    </div>
  `).join("");
}

function removeDraftSlide(i){
  PY_DRAFT.splice(i,1);
  renderDraft();
}

async function savePythonLesson(){
  try{
    const title = ($("#pyTitle").value||"").trim();
    if(!title) throw new Error("اكتب عنوان الدرس");
    if(PY_DRAFT.length === 0) throw new Error("أضف على الأقل شريحة واحدة");

    await api("/api/admin/pythonlessons", { method:"POST", body: JSON.stringify({ title, slides: PY_DRAFT }) });
    PY_DRAFT = [];
    $("#pyTitle").value = "";
    showAlert("ok","تم حفظ درس بايثون ✅");
    await route();
  }catch(e){ showAlert("bad", e.message); }
}

async function delPythonLesson(id){
  if(!confirm("حذف درس بايثون؟")) return;
  try{
    await api("/api/admin/pythonlessons/"+id, { method:"DELETE" });
    showAlert("ok","تم حذف الدرس ✅");
    await route();
  }catch(e){ showAlert("bad", e.message); }
}

/* (اختياري) إعادة ضبط: هنا من الواجهة فقط — الأفضل ما نعملها على السيرفر بدون endpoint */
function resetAllConfirm(){
  showAlert("warn","لأمان أعلى: إذا بدك Reset كامل، احكيلي وبضيف زر Reset على السيرفر.");
}

/* Boot */
window.addEventListener("hashchange", route);
renderNav();
route();
</script>
</body>
</html>
